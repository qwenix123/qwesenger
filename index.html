<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мессенджер "Амперсанд" (v4 Логин)</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
      // ======================================================
      // == ⚠️ ВСТАВЬТЕ ВАШИ КЛЮЧИ ИЗ FIREBASE СЮДА ⚠️ ==
      // ======================================================
      const firebaseConfig = {
        apiKey: "AIz...ВАШ_КЛЮЧ...E4",
        authDomain: "vash-proekt.firebaseapp.com",
        projectId: "vash-proekt",
        storageBucket: "vash-proekt.appspot.com",
        messagingSenderId: "1234567890",
        appId: "1:123...ВАШ_APP_ID...90"
      };
      // ======================================================

      // Инициализация Firebase
      firebase.initializeApp(firebaseConfig);

      // Получаем доступ к сервисам
      const auth = firebase.auth();
      const db = firebase.firestore();
      const googleProvider = new firebase.auth.GoogleAuthProvider();

    </script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Roboto:wght@400&display=swap');

        /* Общие сбросы и фон */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #3d352a;
            color: #333;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Экран Логина/Регистрации --- */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(61, 53, 42, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }

        .login-box {
            width: 400px;
            padding: 30px 40px;
            background: #fdf5e6;
            border: 3px solid #5a4a3a;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            font-family: 'Merriweather', serif;
            /* * =============================
             * == ИЗМЕНЕНИЕ: ЦЕНТРОВКА ==
             * =============================
             * Центрируем весь текст в .login-box (кнопки, заголовки)
             */
            text-align: center;
        }

        .login-box h2 { color: #5a4a3a; margin-top: 0; }

        .login-box .input-group {
            margin-bottom: 20px;
            /* * ИЗМЕНЕНИЕ: Выравниваем лейблы и инпуты по левому краю */
            text-align: left;
        }

        .login-box label { display: block; margin-bottom: 8px; font-size: 14px; color: #7a6a5a; }
        .login-box input[type="text"],
        .login-box input[type="email"],
        .login-box input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid #b8a99a;
            border-radius: 5px;
            background-color: #fff;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
        }

        /* * =============================
         * == ИЗМЕНЕНИЕ: КНОПКИ ЛОГИНА ==
         * =============================
         */
        .login-box .login-button {
            /* width: 100%; (УБРАЛИ) */
            padding: 12px 30px; /* Было 14px (Сделали меньше) */
            border: none;
            border-radius: 5px;
            background-color: #b87333;
            color: white;
            font-family: 'Merriweather', serif;
            font-size: 15px; /* (Чуть меньше) */
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-block; /* Чтобы кнопка была в потоке */
            margin-top: 10px;
        }
        .login-box .login-button:hover { background-color: #a0642a; }

        .login-box .google-button {
            /* width: calc(100% - 2px); (УБРАЛИ) */
            padding: 12px 25px; /* Было 13px (Сделали меньше) */
            border: 1px solid #b8a99a;
            border-radius: 5px;
            background-color: #fff;
            color: #333;
            font-family: 'Roboto', sans-serif;
            font-size: 15px; /* (Чуть меньше) */
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex; /* (inline-flex для иконки) */
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .login-box .google-button:hover { background-color: #f5efe6; }

        /* * =============================
         * == ИЗМЕНЕНИЕ: РАЗДЕЛИТЕЛЬ "ИЛИ" ==
         * =============================
         */
        .login-box .separator {
            display: flex;
            align-items: center;
            text-align: center;
            color: #7a6a5a;
            margin: 25px 0; /* (Больше отступ) */
            font-size: 14px;
        }
        .login-box .separator::before,
        .login-box .separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #c9bFAA; /* Элегантная линия */
        }
        .login-box .separator::before {
            margin-right: 15px; /* Отступ от линии до текста */
        }
        .login-box .separator::after {
            margin-left: 15px; /* Отступ от текста до линии */
        }

        .login-box .error-message { color: #D8000C; background-color: #FFD2D2; padding: 10px; border-radius: 5px; text-align: center; font-size: 14px; font-family: 'Roboto', sans-serif; display: none; margin-bottom: 15px; }
        .login-box .toggle-form { text-align: center; font-size: 14px; color: #5a4a3a; cursor: pointer; text-decoration: underline; margin-top: 20px; }
        .login-box .toggle-form:hover { color: #b87333; }

        /* --- Модальное окно Профиля --- */
        .profile-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(61, 53, 42, 0.7); display: none; justify-content: center; align-items: center; z-index: 50;
        }
        .profile-modal { width: 450px; background: #fdf5e6; border: 3px solid #5a4a3a; border-radius: 8px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); font-family: 'Merriweather', serif; overflow: hidden; }
        .profile-header { padding: 30px; text-align: center; background: #e8e0d4; border-bottom: 2px solid #c9bFAA; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #b87333; margin-bottom: 15px; background: #5a4a3a; color: white; display: inline-flex; justify-content: center; align-items: center; font-size: 60px; }
        .profile-name { font-size: 24px; font-weight: bold; color: #4a3c2c; margin: 0; }
        .profile-username { font-size: 16px; color: #7a6a5a; word-break: break-all; }
        .profile-body { padding: 30px; }
        .profile-close-button { display: block; width: calc(100% - 60px); margin: 20px 30px 30px; padding: 12px; text-align: center; border: 1px solid #b8a99a; border-radius: 5px; background-color: #fff; color: #5a4a3a; font-family: 'Merriweather', serif; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        .profile-close-button:hover { background-color: #f5efe6; }
        .logout-button { background-color: #D8000C; color: white; margin-top: 0; }
        .logout-button:hover { background-color: #a00000; }

        /* --- Стили Мессенджера (НА ВЕСЬ ЭКРАН) --- */
        .messenger-container {
            width: 100vw;
            height: 100vh;
            max-width: none;
            border: none;
            border-radius: 0;
            box-shadow: none;
            background-color: #fdf5e6;
            display: flex;
            overflow: hidden;
            font-family: 'Merriweather', serif;
            display: none;
        }

        .sidebar {
            width: 35%; min-width: 300px; max-width: 450px; background-color: #e8e0d4; border-right: 2px solid #c9bFAA; display: flex; flex-direction: column;
        }
        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #c9bFAA; }
        .sidebar-header h2 { margin: 0; font-size: 22px; color: #5a4a3a; }
        .sidebar-header .icon-button { font-size: 22px; }

        .contact-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .contact { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #dcd0c0; cursor: pointer; transition: background-color 0.2s; }
        .contact:hover { background-color: #f5efe6; }
        .contact.active { background-color: #ffffff; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; border: 2px solid #b87333; background: #5a4a3a; color: white; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; }
        .contact-info { flex-grow: 1; overflow: hidden; }
        .contact-name { display: block; font-weight: bold; font-size: 16px; color: #4a3c2c; }
        .last-message { font-size: 14px; color: #7a6a5a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .time { font-size: 12px; color: #7a6a5a; margin-left: 10px; }

        .chat-window {
            width: 100%; display: flex; flex-direction: column; background-image: url('https://www.transparenttextures.com/patterns/paper.png'); background-color: #fdf5e6;
        }
        .chat-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #c9bFAA; background-color: #f5efe6; }
        .chat-header h3 { margin: 0; font-size: 18px; color: #5a4a3a; }
        .header-buttons { display: flex; gap: 15px; }

        .message-area {
            flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
        }
        .message { padding: 12px 18px; border-radius: 10px; max-width: 70%; line-height: 1.5; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); font-family: 'Roboto', sans-serif; }
        .message-time { display: block; font-size: 11px; color: #8a7a6a; margin-top: 5px; text-align: right; }
        .message.incoming { background-color: #ffffff; border: 1px solid #dcd0c0; align-self: flex-start; }
        .message.outgoing { background-color: #e6f0d9; border: 1px solid #c9d8b6; align-self: flex-end; }
        .message-sender { font-weight: bold; color: #b87333; margin-bottom: 5px; font-size: 13px; }

        .input-area { display: flex; align-items: center; padding: 15px 20px; background-color: #e8e0d4; border-top: 2px solid #c9bFAA; }
        .input-area input[type="text"] { flex-grow: 1; padding: 12px 15px; border: 1px solid #b8a99a; border-radius: 20px; background-color: #fdf5e6; font-family: 'Roboto', sans-serif; font-size: 14px; color: #333; }
        .input-area input[type="text"]:focus { outline: none; border-color: #b87333; }

        .icon-button { background: none; border: none; font-size: 20px; color: #7a6a5a; cursor: pointer; padding: 5px; transition: color 0.2s; }
        .icon-button:hover { color: #b87333; }
        .send-button { background-color: #b87333; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 18px; margin-left: 15px; cursor: pointer; transition: background-color 0.2s; }
        .send-button:hover { background-color: #a0642a; }

    </style>
</head>
<body>

    <div class="login-overlay" id="loginOverlay">
        <div class="login-box" id="loginMode">
            <h2>Вход в "Амперсанд"</h2>
            <div class="error-message" id="loginError"></div>
            <div class="input-group">
                <label for="login-email">Почта</label>
                <input type="email" id="login-email" placeholder="example@mail.com">
            </div>
            <div class="input-group">
                <label for="login-pass">Пароль</label>
                <input type="password" id="login-pass" placeholder="••••••••">
            </div>
            <button class="login-button" id="emailLoginButton">Войти</button>
            <p class="separator">или</p>
            <button class="google-button" id="googleLoginButton">
                <i class="fab fa-google"></i>
                Войти через Google
            </button>
            <p class="toggle-form" id="showRegister">Нет аккаунта? Зарегистрироваться</p>
        </div>

        <div class="login-box" id="registerMode" style="display: none;">
            <h2>Регистрация</h2>
            <div class="error-message" id="registerError"></div>
            <div class="input-group">
                <label for="reg-username">Ваш Юзернейм (Имя)</label>
                <input type="text" id="reg-username" placeholder="Александр">
            </div>
            <div class="input-group">
                <label for="reg-email">Почта</label>
                <input type="email" id="reg-email" placeholder="example@mail.com">
            </div>
            <div class="input-group">
                <label for="reg-pass">Пароль</label>
                <input type="password" id="reg-pass" placeholder="••••••••">
            </div>
            <button class="login-button" id="emailRegisterButton">Зарегистрироваться</button>
            <p class="toggle-form" id="showLogin">Уже есть аккаунт? Войти</p>
        </div>
    </div>

    <div class="profile-modal-overlay" id="profileOverlay">
        <div class="profile-modal">
            <header class="profile-header">
                <div class="profile-avatar" id="profileAvatar">A</div>
                <h2 class="profile-name" id="profileName">Загрузка...</h2>
                <span class="profile-username" id="profileEmail">...</span>
            </header>
            <section class="profile-body">
                <button class="profile-close-button logout-button" id="logoutButton">Выйти из аккаунта</button>
                <button class="profile-close-button" id="closeProfileButton">Закрыть</button>
            </section>
        </div>
    </div>


    <div class="messenger-container" id="messengerApp">

        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Вестники &</h2>
                <button class="icon-button" id="openProfileButton"><i class="fas fa-user-circle"></i></button>
            </div>

            <ul class="contact-list">
                <li class="contact active">
                    <div class="avatar">#</div>
                    <div class="contact-info">
                        <span class="contact-name"># general</span>
                        <span class="last-message">Общий чат...</span>
                    </div>
                </li>
            </ul>
        </nav>

        <main class="chat-window">

            <header class="chat-header">
                <h3># general</h3>
                <div class="header-buttons">
                    <button class="icon-button"><i class="fas fa-ellipsis-v"></i></button>
                </div>
            </header>

            <section class="message-area" id="messageArea">
                </section>

            <footer class="input-area">
                <button class="icon-button"><i class="fas fa-paperclip"></i></button>
                <input type="text" placeholder="Напишите вашу телеграмму..." id="messageInput">
                <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
            </footer>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Глобальная переменная для текущего пользователя
            let currentUser = null;

            // --- Элементы DOM ---
            const loginOverlay = document.getElementById('loginOverlay');
            const messengerApp = document.getElementById('messengerApp');
            const loginMode = document.getElementById('loginMode');
            const registerMode = document.getElementById('registerMode');
            const showRegister = document.getElementById('showRegister');
            const showLogin = document.getElementById('showLogin');
            const googleLoginButton = document.getElementById('googleLoginButton');
            const emailLoginButton = document.getElementById('emailLoginButton');
            const emailRegisterButton = document.getElementById('emailRegisterButton');
            const logoutButton = document.getElementById('logoutButton');
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            const messageArea = document.getElementById('messageArea');
            const loginError = document.getElementById('loginError');
            const registerError = document.getElementById('registerError');
            const profileOverlay = document.getElementById('profileOverlay');
            const openProfileButton = document.getElementById('openProfileButton');
            const closeProfileButton = document.getElementById('closeProfileButton');

            // --- 1. Логика Переключения Вход/Регистрация ---
            showRegister.addEventListener('click', () => {
                loginMode.style.display = 'none';
                registerMode.style.display = 'block'; // Используем block
                registerError.style.display = 'none'; // Сбрасываем ошибки
                loginError.style.display = 'none';
            });
            showLogin.addEventListener('click', () => {
                loginMode.style.display = 'block'; // Используем block
                registerMode.style.display = 'none';
                registerError.style.display = 'none';
                loginError.style.display = 'none';
            });

            // --- 2. Логика Аутентификации ---

            // Вход через Google
            googleLoginButton.addEventListener('click', () => {
                auth.signInWithPopup(googleProvider).catch(e => showError(e, 'login'));
            });

            // Регистрация по Email
            emailRegisterButton.addEventListener('click', () => {
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-pass').value;
                const username = document.getElementById('reg-username').value;

                if (!username || !email || !pass) {
                    showError("Пожалуйста, заполните все поля.", 'register');
                    return;
                }

                auth.createUserWithEmailAndPassword(email, pass)
                    .then(userCredential => {
                        return userCredential.user.updateProfile({
                            displayName: username
                        });
                    })
                    .catch(e => showError(e, 'register'));
            });

            // Вход по Email
            emailLoginButton.addEventListener('click', () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                if (!email || !pass) {
                    showError("Пожалуйста, введите email и пароль.", 'login');
                    return;
                }
                auth.signInWithEmailAndPassword(email, pass).catch(e => showError(e, 'login'));
            });

            // Выход
            logoutButton.addEventListener('click', () => {
                auth.signOut();
                profileOverlay.style.display = 'none';
            });

            // --- 3. Главный слушатель состояния Auth ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Пользователь вошел
                    currentUser = user;
                    loginOverlay.style.display = 'none';
                    messengerApp.style.display = 'flex';
                    initChat(user);
                } else {
                    // Пользователь вышел
                    currentUser = null;
                    loginOverlay.style.display = 'flex';
                    loginMode.style.display = 'block';
                    registerMode.style.display = 'none';
                    messengerApp.style.display = 'none';
                    if (messageArea) messageArea.innerHTML = '';
                }
            });

            // --- 4. Логика Чата ---

            let unsubscribeFromMessages = null;

            function initChat(user) {
                loadProfile(user);

                messageArea.innerHTML = '';

                if (unsubscribeFromMessages) {
                    unsubscribeFromMessages();
                }

                unsubscribeFromMessages = db.collection('messages')
                    .orderBy('timestamp')
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const data = change.doc.data();
                                // Проверяем, что все данные есть
                                if(data.text && data.senderName) {
                                    displayMessage(data.text, data.senderName, data.senderId === user.uid);
                                }
                            }
                        });
                        messageArea.scrollTop = messageArea.scrollHeight;
                    });
            }

            // Отправка сообщения
            function sendMessage() {
                const text = messageInput.value;
                if (text.trim() === '' || !currentUser) return;

                db.collection('messages').add({
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    messageInput.value = '';
                    messageArea.scrollTop = messageArea.scrollHeight;
                })
                .catch(e => console.error("Ошибка отправки: ", e));
            }

            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });

            // Отображение сообщения в DOM
            function displayMessage(text, senderName, isOutgoing) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;

                let content = '';
                if (!isOutgoing) {
                    content += `<div class="message-sender">${senderName || 'Аноним'}</div>`;
                }

                // Простая защита от HTML-инъекций
                const safeText = document.createTextNode(text).textContent;

                content += `<span class="message-text">${safeText}</span>`;
                content += `<span class="message-time">${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</span>`;

                messageDiv.innerHTML = content;
                messageArea.appendChild(messageDiv);
            }

            // --- 5. Логика Профиля ---
            function loadProfile(user) {
                const name = user.displayName;
                const email = user.email;

                document.getElementById('profileName').textContent = name || 'Пользователь';
                document.getElementById('profileEmail').textContent = email;
                const initial = (name || email)[0].toUpperCase();
                document.getElementById('profileAvatar').textContent = initial;
            }

            openProfileButton.addEventListener('click', () => {
                if (currentUser) loadProfile(currentUser);
                profileOverlay.style.display = 'flex';
            });
            closeProfileButton.addEventListener('click', () => profileOverlay.style.display = 'none');
            profileOverlay.addEventListener('click', e => {
                if (e.target === profileOverlay) profileOverlay.style.display = 'none';
            });


            // --- 6. Обработка ошибок ---
            function showError(error, type = 'login') {
                let message = "Произошла неизвестная ошибка.";

                // Если это объект ошибки, а не строка
                if (typeof error === 'object' && error.message) {
                    message = error.message;
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        message = 'Неверный email или пароль.';
                    } else if (error.code === 'auth/email-already-in-use') {
                        message = 'Этот email уже зарегистрирован.';
                    } else if (error.code === 'auth/weak-password') {
                        message = 'Пароль слишком слабый (нужно 6+ символов).';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Некорректный формат email.';
                    }
                } else if (typeof error === 'string') {
                    message = error; // Если мы сами передали строку
                }

                const errorBox = (type === 'login') ? loginError : registerError;
                errorBox.textContent = message;
                errorBox.style.display = 'block';
            }

        });
    </script>

</body>
</html>